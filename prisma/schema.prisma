generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------- ENUMS --------------------
enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
}

enum ServiceType {
  residential_care
  domiciliary_care
  nursing_care
  supported_living
  other
}

enum StaffRole {
  nurse
  senior_hca
  hca_carer
  support_worker
}

enum ComplianceStatus {
  pending
  approved
  rejected
}

enum CertificateType {
  care_certificate
  moving_handling
  first_aid
  basic_life_support
  infection_control
  safeguarding
  health_safety
  equality_diversity
  coshh
  medication_training
  nvq_iii
  additional_training
}

enum CertificateVerificationStatus {
  pending
  verified
  rejected
}

enum EmployeeRole {
  manager
  scheduler
  hr_manager
  finance_officer
  compliance_officer
  general_staff
}

enum EmployeePermissionType {
  post_new_shifts // create and publish shift requests
  assign_shift_applicants // review and assign applicants
  add_emergency_bonus // give bonus incentives
  favorite_block_workers // favorite or block staff
  approve_timesheets // approve submitted timesheets
  dispute_timesheets // handle shift/time disputes
  view_invoices // view and download billing data
  manage_team_permissions // add/remove team members or edit permissions
}

enum ShiftStatus {
  draft
  published
  assigned
  completed
  cancelled
}

enum ShiftType {
  long_day
  day
  night
  live_in
  sleep_in
  part_time
  other
}

enum ProfessionRole {
  nurse
  senior_hca
  hca_carer
  support_worker
  other
}

enum ShiftApplicationStatus {
  pending
  accepted
  rejected
  cancelled
}

enum ShiftAttendanceStatus {
  not_checked_in
  checked_in
  checked_out
}

enum TimesheetStatus {
  pending_submission
  submitted
  under_review
  approved
  rejected
  paid
}

enum StaffPreferenceType {
  favorite
  blocked
}

// -------------------- MODELS --------------------

// --------- Core Models ---------
model Account {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  type                String?
  provider            String?
  provider_account_id String?
  refresh_token       String?
  access_token        String?
  expires_at          DateTime?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?

  @@unique([provider, provider_account_id])
  @@map("accounts")
}

model User {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?
  status     Int?      @default(1) @db.SmallInt

  approved_at  DateTime?
  availability String?

  email    String? @unique
  password String? // Hashed password for authentication

  // Registration flow fields
  onboarding_step String? @default("account_type") // account_type → email → email_verify → profile_setup → completed

  // billing id. e.g. stripe customer id
  billing_id String?

  // User type: "staff" | "service_provider" | "admin" | "user" (default)
  // Used for registration flow and user type identification
  type              String?   @default("user")
  email_verified_at DateTime?

  is_two_factor_enabled Int?    @default(0)
  two_factor_secret     String? // secret key for two factor authentication

  accounts                  Account[]
  creator_conversations     Conversation[] @relation("creator")
  participant_conversations Conversation[] @relation("participant")
  receiver_messages         Message[]      @relation("receiver")
  sender_messages           Message[]      @relation("sender")
  receiver_notifications    Notification[] @relation("receiver")
  sender_notifications      Notification[] @relation("sender")

  user_payment_methods UserPaymentMethod[]
  user_settings        UserSetting[]
  ucodes               Ucode[]
  roles                Role[]
  role_users           RoleUser[]
  payment_transactions PaymentTransaction[]

  // Care Home Staffing App Relations
  service_provider_info ServiceProviderInfo?
  staff_profile         StaffProfile?

  @@map("users")
}

model Ucode {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  status     Int?     @default(1) @db.SmallInt

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  token      String?
  email      String?
  expired_at DateTime?

  @@map("ucodes")
}

// --------- Auth & Role Models ---------
model Role {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status Int?    @default(1) @db.SmallInt
  title  String?
  name   String?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  permission_roles PermissionRole[]
  role_users       RoleUser[]
  permissions      Permission[]     @relation("PermissionToRole")

  @@map("roles")
}

model Permission {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  title      String?
  action     String?
  subject    String?
  conditions String?
  fields     String?

  permission_roles PermissionRole[]
  roles            Role[]           @relation("PermissionToRole")

  @@map("permissions")
}

model PermissionRole {
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  permission_id String
  permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  role_id String
  role    Role   @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([permission_id, role_id])
  @@map("permission_roles")
}

model RoleUser {
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  role_id String
  role    Role   @relation(fields: [role_id], references: [id], onDelete: Cascade)

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([role_id, user_id])
  @@map("role_users")
}

// --------- Notification Models ---------
model NotificationEvent {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status Int?    @default(1) @db.SmallInt
  type   String?
  text   String?

  notifications Notification[]

  @@map("notification_events")
}

model Notification {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  read_at DateTime?

  status Int? @default(1) @db.SmallInt

  sender_id String?
  sender    User?   @relation("sender", fields: [sender_id], references: [id])

  receiver_id String?
  receiver    User?   @relation("receiver", fields: [receiver_id], references: [id])

  notification_event_id String?
  notification_event    NotificationEvent? @relation(fields: [notification_event_id], references: [id])

  entity_id String?

  @@map("notifications")
}

// --------- Payment Models ---------
model UserPaymentMethod {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  payment_method_id String?
  checkout_id       String?

  @@map("user_payment_methods")
}

model PaymentTransaction {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  store_id String?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  order_id         String?
  type             String?  @default("order")
  withdraw_via     String?  @default("wallet")
  provider         String?
  reference_number String?
  status           String?  @default("pending")
  raw_status       String?
  amount           Decimal?
  currency         String?
  paid_amount      Decimal?
  paid_currency    String?

  @@map("payment_transactions")
}

// --------- Chat Models ---------
model Message {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status MessageStatus? @default(PENDING)

  sender_id String?
  sender    User?   @relation("sender", fields: [sender_id], references: [id])

  receiver_id String?
  receiver    User?   @relation("receiver", fields: [receiver_id], references: [id])

  conversation_id String?
  conversation    Conversation? @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  attachment_id String?
  attachment    Attachment? @relation(fields: [attachment_id], references: [id])

  message String?

  @@map("messages")
}

model Attachment {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  name     String?
  type     String?
  size     Int?
  file     String?
  file_alt String?

  messages Message[]

  @@map("attachments")
}

model Conversation {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  creator_id String?
  creator    User?   @relation("creator", fields: [creator_id], references: [id])

  participant_id String?
  participant    User?   @relation("participant", fields: [participant_id], references: [id])

  messages Message[]

  @@map("conversations")
}

// --------- Care Home Staffing App Models ---------
// Service Provider Models
model ServiceProviderInfo {
  id                  String      @id @default(cuid())
  user_id             String      @unique
  first_name          String
  last_name           String
  mobile_code         String?
  mobile_number       String?
  brand_logo_url      String?
  agreed_to_terms     Boolean     @default(false)
  organization_name   String
  website             String?
  cqc_provider_number String
  vat_tax_id          String?
  primary_address     String
  main_service_type   ServiceType
  max_client_capacity Int
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  user              User                      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  employees         Employee[]
  shifts            Shift[]
  staff_preferences ProviderStaffPreference[]
  staff_reviews     StaffPerformanceReview[]

  @@map("service_provider_infos")
}

model Employee {
  id                  String       @id @default(cuid())
  user_id             String? // optional: if employee has User account, link here
  service_provider_id String
  first_name          String
  last_name           String
  email               String       @unique
  phone_number        String?
  employee_role       EmployeeRole // Organization-level role (manager, scheduler, etc.)
  is_active           Boolean      @default(true)
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  service_provider_info ServiceProviderInfo       @relation(fields: [service_provider_id], references: [id], onDelete: Cascade)
  permissions           EmployeePermission[] // Organization-specific permissions
  shifts_created        Shift[]                   @relation("EmployeeCreatedShifts")
  preferences           ProviderStaffPreference[]

  @@map("employees")
}

model EmployeePermission {
  id          String                 @id @default(cuid())
  employee_id String
  permission  EmployeePermissionType // Specific permission from enum
  is_granted  Boolean                @default(true) // Can be revoked without deleting record
  created_at  DateTime               @default(now())
  updated_at  DateTime               @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@unique([employee_id, permission]) // One permission record per employee per permission type
  @@map("employee_permissions")
}

// Staff Models
model StaffProfile {
  id              String   @id @default(cuid())
  user_id         String   @unique
  first_name      String
  last_name       String
  mobile_code     String?
  mobile_number   String?
  date_of_birth   DateTime
  photo_url       String?
  agreed_to_terms Boolean  @default(false)

  // Step 2: Role & Work Status
  roles                StaffRole[] // additional roles (multi-select)
  right_to_work_status String
  cv_url               String?

  // Step 2B: Certificates
  certificates StaffCertificate[]

  // Step 3: DBS & Compliance
  dbs_info StaffDbsInfo?

  profile_completion  Int     @default(0) // percentage (0–100)
  is_profile_complete Boolean @default(false) // quick flag for checks

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user            User                      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shifts_assigned Shift[]                   @relation("AssignedShiftStaff")
  applications    ShiftApplication[]
  attendances     ShiftAttendance[]
  timesheets      ShiftTimesheet[]
  preferences     ProviderStaffPreference[]
  reviews         StaffPerformanceReview[]

  @@map("staff_profiles")
}

model StaffCertificate {
  id               String                        @id @default(cuid())
  staff_id         String
  certificate_type CertificateType
  file_url         String?
  uploaded_at      DateTime                      @default(now())
  verified_status  CertificateVerificationStatus @default(pending)

  // Expiry tracking for notifications
  expiry_date        DateTime?
  expiry_notified_at DateTime? // Track when notification was sent

  staff StaffProfile @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@map("staff_certificates")
}

model StaffDbsInfo {
  id                      String   @id @default(cuid())
  staff_id                String   @unique
  certificate_number      String
  surname_as_certificate  String
  date_of_birth_on_cert   DateTime
  certificate_print_date  DateTime
  is_registered_on_update Boolean  @default(false)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  staff StaffProfile @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@map("staff_dbs_infos")
}

// Shift Models
model Shift {
  id                     String  @id @default(cuid())
  service_provider_id    String
  created_by_employee_id String? // Manager or Scheduler who created it
  assigned_staff_id      String? // Assigned staff (optional)

  // Shift Details
  posting_title   String
  shift_type      ShiftType
  profession_role ProfessionRole
  is_urgent       Boolean        @default(false)

  // Schedule
  start_date DateTime
  end_date   DateTime?
  start_time DateTime
  end_time   DateTime

  // Location
  facility_name String
  full_address  String

  // Pay
  pay_rate_hourly    Float
  signing_bonus      Float?  @default(0)
  internal_po_number String?
  emergency_bonus    Float?  @default(0)

  // Notes
  notes String?

  // Status
  status ShiftStatus @default(draft)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  service_provider_info ServiceProviderInfo      @relation(fields: [service_provider_id], references: [id], onDelete: Cascade)
  created_by_employee   Employee?                @relation("EmployeeCreatedShifts", fields: [created_by_employee_id], references: [id])
  assigned_staff        StaffProfile?            @relation("AssignedShiftStaff", fields: [assigned_staff_id], references: [id])
  applications          ShiftApplication[]
  attendance            ShiftAttendance?
  timesheet             ShiftTimesheet?
  reviews               StaffPerformanceReview[]

  @@map("shifts")
}

model ShiftApplication {
  id          String                 @id @default(cuid())
  shift_id    String
  staff_id    String
  status      ShiftApplicationStatus @default(pending)
  applied_at  DateTime               @default(now())
  reviewed_at DateTime?
  notes       String? // optional reason or message

  shift Shift        @relation(fields: [shift_id], references: [id], onDelete: Cascade)
  staff StaffProfile @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@unique([shift_id, staff_id])
  @@map("shift_applications")
}

model ShiftAttendance {
  id             String                @id @default(cuid())
  shift_id       String                @unique
  staff_id       String
  status         ShiftAttendanceStatus @default(not_checked_in)
  check_in_time  DateTime?
  check_out_time DateTime?
  location_check String? // optional GPS or facility confirmation
  created_at     DateTime              @default(now())
  updated_at     DateTime              @updatedAt

  shift Shift        @relation(fields: [shift_id], references: [id], onDelete: Cascade)
  staff StaffProfile @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@map("shift_attendances")
}

model ShiftTimesheet {
  id       String @id @default(cuid())
  shift_id String @unique
  staff_id String

  total_hours Float?
  hourly_rate Float?
  total_pay   Float?
  notes       String?

  status              TimesheetStatus @default(pending_submission)
  verification_method String? // e.g. "Geofence Verified", "Manual Verification"
  clock_in_verified   Boolean?        @default(false)
  clock_out_verified  Boolean?        @default(false)

  submitted_at DateTime?
  reviewed_at  DateTime?
  approved_by  String? // admin or manager ID
  paid_at      DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  shift Shift        @relation(fields: [shift_id], references: [id], onDelete: Cascade)
  staff StaffProfile @relation(fields: [staff_id], references: [id], onDelete: Cascade)

  @@map("shift_timesheets")
}

// Preference & Review Models
model ProviderStaffPreference {
  id                 String              @id @default(cuid())
  provider_id        String // from service_provider_info
  staff_id           String // from staff_profile
  set_by_employee_id String? // optional: who marked them
  preference_type    StaffPreferenceType // favorite / blocked
  reason             String? // optional note or reason
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt

  // Relations
  provider        ServiceProviderInfo @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  staff           StaffProfile        @relation(fields: [staff_id], references: [id], onDelete: Cascade)
  set_by_employee Employee?           @relation(fields: [set_by_employee_id], references: [id])

  @@unique([provider_id, staff_id, preference_type]) // prevent duplicates
  @@map("provider_staff_preferences")
}

model StaffPerformanceReview {
  id          String   @id @default(cuid())
  provider_id String
  staff_id    String
  shift_id    String
  rating      Int // 1–5 stars
  feedback    String?
  created_by  String? // employee_id of reviewer (optional)
  admin_alert Boolean  @default(false) // trigger if rating < 3
  created_at  DateTime @default(now())

  // Relations
  provider ServiceProviderInfo @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  staff    StaffProfile        @relation(fields: [staff_id], references: [id], onDelete: Cascade)
  shift    Shift               @relation(fields: [shift_id], references: [id], onDelete: Cascade)

  @@unique([shift_id, staff_id]) // one review per staff per shift
  @@map("staff_performance_reviews")
}

// --------- Admin & Config Models ---------
model Faq {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  sort_order Int?    @default(0)
  question   String?
  answer     String?

  @@map("faqs")
}

model Contact {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  first_name   String?
  last_name    String?
  email        String?
  phone_number String?
  message      String?

  @@map("contacts")
}

model SocialMedia {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  status     Int?    @default(1) @db.SmallInt
  sort_order Int?    @default(0)
  name       String?
  url        String?
  icon       String?

  @@map("social_medias")
}

model WebsiteInfo {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  name                String?
  phone_number        String?
  email               String?
  address             String?
  logo                String?
  favicon             String?
  copyright           String?
  cancellation_policy String?

  @@map("website_infos")
}

model Setting {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  category      String?
  label         String?
  description   String?
  key           String? @unique
  default_value String?

  user_settings UserSetting[]

  @@map("settings")
}

model UserSetting {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  setting_id String?
  setting    Setting? @relation(fields: [setting_id], references: [id])

  value String?

  @@map("user_settings")
}

// this table stores example
// model Note {
//   id                String  @id @default(cuid())
//   created_at DateTime  @default(now())
//   updated_at DateTime  @default(now())
//   deleted_at DateTime?
//   status     Int?      @default(1) @db.SmallInt
//
//   title String?
//   body  String? @db.Text
//
//   tenant_id Int?
//   tenant    Organization? @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
//   @@map("posts")
// }
